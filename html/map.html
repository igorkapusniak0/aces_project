<!DOCTYPE html>
<html>
<head>
  <title>Need For No Speed - Sim Map</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="jlr.png">
  <style>
  #map-container {
    position: relative;
    width: 700px;
    height: 599px;
    margin: auto;
    border: 1px solid #ccc; 
  }

  #map-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .map-marker {
    position: absolute;
    width: 12px;
    height: 12px;
    background-color: red;
    border-radius: 50%;
    border: 2px solid white;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }
  </style>
</head>
<body class="bg-light">

  <div id="navbar"></div>

  <!-- Map -->
  <main class="container my-5 text-center">
    <h1 class="mb-4" style="color: #ea9b1a;">Map of Need For No Speed</h1>
    
    <div id="map-container">
      <img id="map-image" src="map6.png" alt="Map">
    </div>

    <div class="mt-4">
      <a href="leaderboard.html" class="btn btn-warning me-2">Back to Leaderboard</a>
      <a href="stats.html" class="btn btn-warning">My Stats</a>
    </div>
  </main>

  <div id="footer"></div>

  <script src="app.js"></script>
  <script>
  fetch('navbar.html')
    .then(res => res.text())
    .then(data => document.getElementById('navbar').innerHTML = data);

  fetch('footer.html')
    .then(res => res.text())
    .then(data => document.getElementById('footer').innerHTML = data);


  const user_id = getUserId(); 


  const mapContainer = document.getElementById("map-container");


  function clearMarkers() {
    const existing = mapContainer.querySelectorAll(".map-marker");
    existing.forEach(el => el.remove());
  }

function addMarker(x, y, name = '', points = 0) {

  const marker = document.createElement("div");
  marker.className = "map-marker";
  marker.style.left = `${x}px`;
  marker.style.top = `${y}px`;
  marker.title = name;


  const pointsBox = document.createElement("div");
  pointsBox.className = "points-box";  // <-- add this line
  pointsBox.textContent = `Points: ${points}`;
  pointsBox.style.position = "absolute";
  pointsBox.style.left = `${x}px`;
  pointsBox.style.top = `${y - 20}px`;
  pointsBox.style.transform = "translate(-50%, -100%)";
  pointsBox.style.backgroundColor = "rgba(255, 255, 255, 0.8)";
  pointsBox.style.border = "1px solid #ccc";
  pointsBox.style.borderRadius = "4px";
  pointsBox.style.padding = "2px 5px";
  pointsBox.style.fontSize = "10px";
  pointsBox.style.pointerEvents = "none";


  mapContainer.appendChild(marker);
  mapContainer.appendChild(pointsBox);
}

function clearMarkers() {
  const markers = mapContainer.querySelectorAll(".map-marker, .points-box");
  markers.forEach(el => el.remove());
}


  function mapCoordToPixel(x, z) {
    const xMin = -140;
    const xMax = 10;
    const zMin = -1.5;
    const zMax = 124;
    const imageWidth = 700;
    const imageHeight = 599;
    const xNorm = (x - xMin) / (xMax - xMin);
    const yNorm = (z - zMin) / (zMax - zMin);
    const px = xNorm * imageWidth;
    const py = (yNorm) * imageHeight;
    return { x: px, y: py };
  }

  async function getLocations(user_id) {
    try {
      const response = await fetch(`${API_BASE}/users/getAllLocal?user_id=${user_id}&range=100`);
      if (!response.ok) throw new Error("Network response was not ok");

      const data = await response.json();
      const coords = data.data;
      console.log(coords);
      clearMarkers();
      coords.forEach(player => {
        const [lat, lon] = player.location;
        if (lat == null || lon == null) return;
        const { x, y } = mapCoordToPixel(lat, lon);
	clearMarkers();
        addMarker(x, y, player.name, player.total_points);
      });
    } catch (error) {
      console.error("error:", error);
      alert("Failed due to network or server error.");
    }
  }

  if (user_id) {
    getLocations(user_id);
    setInterval(() => getLocations(user_id), 1000);
  }
 </script>
</body>
</html>

